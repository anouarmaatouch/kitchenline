<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant AI - Commandes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div id="notification-container"></div>

    <div class="glass header margin-bottom">
        <h1>Dashboard Commandes</h1>
        <div style="display: flex; gap: 1rem; align-items: center;">

            <!-- Agent Status Indicator/Link -->
            <form action="{{ url_for('orders.toggle_agent') }}" method="POST"
                style="margin-right: 1rem; display: flex; align-items: center;">
                <button type="submit" class="badge {{ 'green' if current_user.agent_on else 'red' }}"
                    style="border: none; padding: 6px 12px; border-radius: 20px; background: {{ '#10b98122' if current_user.agent_on else '#ef444422' }}; color: {{ '#10b981' if current_user.agent_on else '#ef4444' }}; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; transition: all 0.2s;">
                    <span style="font-size: 0.8rem; opacity: 0.8;">AGENT</span>
                    <span>{{ 'ON' if current_user.agent_on else 'OFF' }}</span>
                </button>
            </form>

            {% if current_user.is_admin %}
            <a href="{{ url_for('admin.index') }}" class="btn" style="background: var(--accent-warning);">Admin
                Panel</a>
            {% endif %}

            <a href="{{ url_for('orders.demands_dashboard') }}" class="btn"
                style="background: var(--accent-primary);">Demandes Sp√©ciales</a>

            <span>{{ current_user.company }}</span>
            <a href="{{ url_for('auth.logout') }}" class="btn logout-btn">D√©connexion</a>
        </div>
    </div>

    <div class="container board">
        <!-- Ordres re√ßus -->
        <div class="column status-recu">
            <div class="column-header">
                <span class="column-title">Ordres Re√ßus</span>
                <span class="count" id="count-recu">{{ orders_recu|length }}</span>
            </div>
            <div class="order-list" id="list-recu">
                {% for order in orders_recu %}
                <div class="order-card glass" id="order-{{ order.id }}">
                    <div class="order-detail">{{ order.order_detail }}</div>
                    <div class="order-meta">
                        <span>üë§ {{ order.customer_name }}</span>
                        <span>üìû {{ order.customer_phone }}</span>
                        <span>üìç {{ order.address }}</span>
                        <span style="font-size: 0.75rem; opacity: 0.5;">{{ order.created_at.strftime('%H:%M') }}</span>
                    </div>
                    <div class="actions">
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            <button class="action-btn" style="background: rgba(16, 185, 129, 0.2); color: #10b981;"
                                onclick="updateStatus({{ order.id }}, 'en_cours')" title="Approuver">‚úÖ</button>
                            <button class="action-btn" style="background: rgba(255,255,255,0.1); font-size: 0.8rem;"
                                onclick='openEditModal({{ order.to_dict()|tojson }})' title="Modifier">‚úèÔ∏è</button>
                            <button class="action-btn"
                                style="background: rgba(239,68,68,0.2); color: #ef4444; font-size: 0.8rem;"
                                onclick="deleteOrder({{ order.id }})" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Ordres en cours -->
        <div class="column status-en-cours">
            <div class="column-header">
                <span class="column-title">En Cours</span>
                <span class="count" id="count-en-cours">{{ orders_en_cours|length }}</span>
            </div>
            <div class="order-list" id="list-en-cours">
                {% for order in orders_en_cours %}
                <div class="order-card glass" id="order-{{ order.id }}">
                    <div class="order-detail">{{ order.order_detail }}</div>
                    <div class="order-meta">
                        <span>üë§ {{ order.customer_name }}</span>
                        <span>üìû {{ order.customer_phone }}</span>
                    </div>
                    <div class="actions">
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            <button class="action-btn" style="background: rgba(16, 185, 129, 0.2); color: #10b981;"
                                onclick="updateStatus({{ order.id }}, 'termine')" title="Terminer">‚úÖ</button>
                            <button class="action-btn" style="background: rgba(255,255,255,0.1); font-size: 0.8rem;"
                                onclick='openEditModal({{ order.to_dict()|tojson }})' title="Modifier">‚úèÔ∏è</button>
                            <button class="action-btn"
                                style="background: rgba(239,68,68,0.2); color: #ef4444; font-size: 0.8rem;"
                                onclick="deleteOrder({{ order.id }})" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Ordres termin√© -->
        <div class="column status-termine">
            <div class="column-header">
                <span class="column-title">Termin√©</span>
                <span class="count" id="count-termine">{{ orders_termine|length }}</span>
            </div>
            <div class="order-list" id="list-termine">
                {% for order in orders_termine %}
                <div class="order-card glass" id="order-{{ order.id }}">
                    <div class="order-detail">{{ order.order_detail }}</div>
                    <div class="order-meta">
                        <span>üë§ {{ order.customer_name }}</span>
                        <span style="font-size: 0.75rem; opacity: 0.5;">{{ order.created_at.strftime('%H:%M') }}</span>
                    </div>
                    <div class="actions">
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            <button class="action-btn" style="background: rgba(255,255,255,0.1); font-size: 0.8rem;"
                                onclick='openEditModal({{ order.to_dict()|tojson }})' title="Modifier">‚úèÔ∏è</button>
                            <button class="action-btn"
                                style="background: rgba(239,68,68,0.2); color: #ef4444; font-size: 0.8rem;"
                                onclick="deleteOrder({{ order.id }})" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Edit Order Modal (Explicitly Hidden) -->
    <div id="edit-order-modal" class="modal" style="display: none;">
        <div class="modal-content glass">
            <h3>Modifier la commande</h3>
            <input type="hidden" id="edit-order-id">
            <div class="form-group" style="display: flex; flex-direction: column; gap: 1rem;">
                <textarea id="edit-order-detail" rows="4" placeholder="D√©tails de la commande"
                    style="padding: 10px; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;"></textarea>
                <input type="text" id="edit-customer-name" placeholder="Nom Client"
                    style="padding: 10px; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                <input type="text" id="edit-customer-phone" placeholder="T√©l√©phone"
                    style="padding: 10px; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                <input type="text" id="edit-address" placeholder="Adresse"
                    style="padding: 10px; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">

                <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                    <button type="button" class="btn logout-btn" onclick="closeEditModal()">Annuler</button>
                    <button type="button" class="btn" onclick="submitEditOrder()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utilities for VAPID
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function subscribeUserToPush() {
            try {
                // Get Key
                const response = await fetch('/api/vapid_public_key');
                const data = await response.json();
                const publicKey = data.publicKey;
                if (!publicKey) return;

                const registration = await navigator.serviceWorker.register("/static/sw.js");
                await navigator.serviceWorker.ready;

                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicKey)
                });

                // Send to Server
                await fetch('/api/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscription_info: subscription })
                });

                new Notification("Restaurant AI", { body: "Web Push Activ√© !" });

            } catch (e) {
                console.error("Push Error", e);
            }
        }

        // Request Notification Permission on User Interaction (Button)
        document.addEventListener('DOMContentLoaded', () => {
            // Check HTTPS
            if (!window.isSecureContext && location.hostname !== 'localhost') {
                alert("‚ö†Ô∏è ATTENTION: Les notifications n√©cessitent HTTPS (ou localhost). Si vous utilisez une adresse IP (exp: 192.168...), cela ne fonctionnera pas sur mobile !");
            }

            // Register SW immediately if possible
            if ('serviceWorker' in navigator) {
                // Register at root scope
                navigator.serviceWorker.register("/sw.js")
                    .then(reg => console.log("SW Registered at root scope:", reg.scope))
                    .catch(err => console.error("SW Registration Failed:", err));
            }

            // FORCE BUTTON VISIBILITY FOR DEBUGGING if not granted or if user wants to re-subscribe
            // Or create a persistent toggle in a better place.
            // For now, let's make sure it appears if permission is 'default' or even 'granted' (to ensuring subscription).

            const btn = document.createElement('button');
            btn.innerText = "üîî Activer Notifications";
            btn.className = "btn";
            btn.style.position = "fixed";
            btn.style.bottom = "20px";
            btn.style.right = "20px";
            btn.style.zIndex = "1000";
            btn.onclick = () => {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        subscribeUserToPush();
                        alert("Tentative d'abonnement envoy√©e.");
                        btn.style.display = 'none';
                    } else {
                        alert("Permission refus√©e.");
                    }
                });
            };

            // If already granted, maybe we just hide it, but user says they don't see it. 
            // Maybe they denied it? If denied, we can't do much.
            if (Notification.permission === 'denied') {
                console.log("Notifications denied");
            } else if (Notification.permission === 'granted') {
                // Try to subscribe silently, but show button if they want to force it?
                // Let's SHOW it momentarily or permanently for testing.
                subscribeUserToPush();
                // Don't show button if already granted to avoid clutter, UNLESS user specifically asked because they can't see it?
                // User says "I don't see notification", implying they expect the button.
                // If permission is granted but they don't see notifications, maybe subscription failed.

                // Let's add the button regardless but change text if granted
                btn.innerText = "üîî Re-Activer Push";
                document.body.appendChild(btn);
            } else {
                document.body.appendChild(btn);
            }
        });

        // Server Sent Events (Keep as fallback / instant update)
        const evtSource = new EventSource("{{ url_for('orders.events') }}");

        evtSource.onmessage = function (event) {
            const data = JSON.parse(event.data);
            console.log("Event received:", data);

            if (data.type === 'new_order') {
                showNotification(data.data.message || "Nouvel ordre re√ßu !");

                // Simple chime
                try {
                    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                    audio.play().catch(e => console.log('Audio autoplay blocked', e));
                } catch (e) { }

                setTimeout(() => location.reload(), 1000);
            }
        };

        function showNotification(message) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span>üîî</span> ${message}`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function updateStatus(orderId, newStatus) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert("Erreur lors de la mise √† jour");
                }
            } catch (e) {
                console.error(e);
                alert("Erreur r√©seau");
            }
        }

        function openEditModal(order) {
            document.getElementById('edit-order-id').value = order.id;
            document.getElementById('edit-order-detail').value = order.order_detail;
            document.getElementById('edit-customer-name').value = order.customer_name;
            document.getElementById('edit-customer-phone').value = order.customer_phone;
            document.getElementById('edit-address').value = order.address || '';
            document.getElementById('edit-order-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-order-modal').style.display = 'none';
        }

        async function submitEditOrder() {
            const id = document.getElementById('edit-order-id').value;
            const data = {
                order_detail: document.getElementById('edit-order-detail').value,
                customer_name: document.getElementById('edit-customer-name').value,
                customer_phone: document.getElementById('edit-customer-phone').value,
                address: document.getElementById('edit-address').value
            };

            try {
                const res = await fetch(`/api/orders/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) location.reload();
                else alert("Error updating order");
            } catch (e) {
                alert("Network error");
            }
        }

        async function deleteOrder(id) {
            if (!confirm("Supprimer cette commande d√©fnitivement ?")) return;
            try {
                const res = await fetch(`/api/orders/${id}`, { method: 'DELETE' });
                if (res.ok) location.reload();
                else alert("Error deleting order");
            } catch (e) {
                alert("Network error");
            }
        }

        async function testPush() {
            try {
                const res = await fetch('/api/test_push', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert("Notification envoy√©e ! V√©rifiez votre t√©l√©phone/ordinateur.");
                } else {
                    alert("Erreur: " + data.error);
                }
            } catch (e) {
                alert("Erreur r√©seau: " + e);
            }
        }
    </script>
</body>

</html>